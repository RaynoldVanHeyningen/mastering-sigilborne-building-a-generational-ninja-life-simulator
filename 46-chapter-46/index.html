
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../45-chapter-45/">
      
      
        <link rel="next" href="../47-chapter-47/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Chapter 7.3: Stealth Mechanics - Visibility & Detection Meter (C#) - Mastering Sigilborne: Building a Generational Ninja Life Simulator</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="sky" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapter-73-stealth-mechanics-visibility-detection-meter-c" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Mastering Sigilborne: Building a Generational Ninja Life Simulator" class="md-header__button md-logo" aria-label="Mastering Sigilborne: Building a Generational Ninja Life Simulator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Mastering Sigilborne: Building a Generational Ninja Life Simulator
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chapter 7.3: Stealth Mechanics - Visibility & Detection Meter (C#)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Mastering Sigilborne: Building a Generational Ninja Life Simulator" class="md-nav__button md-logo" aria-label="Mastering Sigilborne: Building a Generational Ninja Life Simulator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Mastering Sigilborne: Building a Generational Ninja Life Simulator
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../01-chapter-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.1: Project Setup for Godot 4.5 with C#
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../02-chapter-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.2: The Brain (C#) - Headless Simulation Layer
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../03-chapter-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.3: The Body (GDScript) - Reactive Presentation Layer
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../04-chapter-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.4: Directory Structure - Enforcing Separation of Concerns
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../05-chapter-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.5: Entity Model - Lightweight ECS-lite in C#
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../06-chapter-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.6: Component Architecture - Composition over Inheritance
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../07-chapter-7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.7: Job System & Concurrency - Multithreaded Processing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../08-chapter-8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.8: Thread Safety - Command Buffers & Double Buffering
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../09-chapter-9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.9: Scene Composition - Standardizing Godot Scenes
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../10-chapter-10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.10: Naming Conventions & Scene Interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../11-chapter-11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.11: Animation Event Protocol - Syncing Brain & Body
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../12-chapter-12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.12: Interop Layer - C# to GDScript Communication
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../13-chapter-13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.13: Global State Management - Data Ownership
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../14-chapter-14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.14: Debugging Tools - Console & State Inspector
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../15-chapter-15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.15: Main Loop Execution Order - Tick vs. Frame
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../16-chapter-16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 2.1: Input Manager - Capturing Raw Input (GDScript)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../17-chapter-17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 2.2: Standard Movement Logic - Velocity & Friction (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../18-chapter-18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 2.3: Shift-Sliding Mechanic - Direction Lock (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../19-chapter-19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 2.4: Physics Layer - Hybrid Movement Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../20-chapter-20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3.1: Glyph Database - Concepts vs. Symbols (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../21-chapter-21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3.2: Glyph Discovery System - Player Knowledge State (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../22-chapter-22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3.3: Glyph Experimentation - Trial & Error Casting (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../23-chapter-23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3.4: Subtypes & Modifiers - Procedural Nuance for Glyphs (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../24-chapter-24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3.5: Glyph Acquisition - Teachers & Scrolls (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../25-chapter-25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4.1: Input Buffer - Storing Glyph Sequences (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../26-chapter-26/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4.2: Combo Resolver - Trie Structure for Spell Detection (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../27-chapter-27/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4.3: Spell Data Architecture - Data-Driven Definitions (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../28-chapter-28/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4.4: Casting State Machine - Player Casting Flow (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../29-chapter-29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4.5: Visual Feedback - Particles & Animations (GDScript)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../30-chapter-30/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.1: Biological Simulation - The Bio-Tick (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../31-chapter-31/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.2: Core Stats (Struct)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../32-chapter-32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.3: Metabolism System - Dynamic Decay Rates (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../33-chapter-33/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.4: Weather & Environment - Global Environmental State (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../34-chapter-34/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.5: Damage & Recovery Pipeline - Wounds & Status Effects (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../35-chapter-35/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.6: Status Effect Data - Definition vs. Instance (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../36-chapter-36/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.7: Recovery Logic - Health, Stamina, Chakra Regeneration (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../37-chapter-37/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.8: Weather & Environment - Global Environmental State (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../38-chapter-38/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.1: Physics Layer - Hitbox & Hurtbox Detection (GDScript)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../39-chapter-39/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.2: The Math Layer - Damage Calculator (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../40-chapter-40/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.3: Equipment & Inventory - Inventory Data Structure (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../41-chapter-41/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.4: Equipment Logic - Recalculating Stats (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../42-chapter-42/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.5: World Boss Mechanics - Multi-Part Entities (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../43-chapter-43/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.6: Titan AI State - Specialized State Machine (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../44-chapter-44/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.1: Perception System - Spatial Hashing (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../45-chapter-45/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.2: The Senses - Vision, Hearing & Chakra Sense (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.3: Stealth Mechanics - Visibility & Detection Meter (C#)
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.3: Stealth Mechanics - Visibility & Detection Meter (C#)
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chapter-73-stealth-mechanics-visibility-detection-meter-c" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chapter 7.3: Stealth Mechanics - Visibility &amp; Detection Meter (C#)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter 7.3: Stealth Mechanics - Visibility &amp; Detection Meter (C#)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-the-dynamic-nature-of-stealth" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. The Dynamic Nature of Stealth
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-defining-stealthcomponent-and-detectioncomponent" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Defining StealthComponent and DetectionComponent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-implementing-stealthsystemcs" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Implementing StealthSystem.cs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-integrating-stealthsystem-into-gamemanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Integrating StealthSystem into GameManager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Integrating StealthSystem into GameManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-update-eventbuscs-for-stealth-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1. Update EventBus.cs for Stealth Events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-displaying-detection-meter-in-the-body-gdscript-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Displaying Detection Meter in the Body (GDScript UI)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-testing-stealth-mechanics" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Testing Stealth Mechanics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../47-chapter-47/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.4: Decision Making: Utility AI (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../48-chapter-48/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.5: Ecology Simulation - Virtual Agents (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../49-chapter-49/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.6: Spawning & Despawning - Hydration/Dehydration (Brain & Body)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../50-chapter-50/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.1: Faction System - The Relationship Graph (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../51-chapter-51/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.2: The Simulation Clock - Game Time & Load Balancing (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../52-chapter-52/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.3: Market Simulation - Supply & Demand (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../53-chapter-53/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.4: Trade Routes - Caravans as Arteries (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../54-chapter-54/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.5: Crime & Justice - The Heat System (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../55-chapter-55/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.6: Bounty & Punishment - Escalation & Consequences (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../56-chapter-56/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9.1: Ritual System - Pattern Matching & Execution (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../57-chapter-57/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9.2: Seals & Locks - Logical Locks (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../58-chapter-58/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9.3: Ritual System - Simple, Advanced & Forbidden (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../59-chapter-59/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9.4: Forbidden Contracts & Spirit Contracts (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../60-chapter-60/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9.5: Corruption Pacts & Multi-Life Persistence of Rituals (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chapter-73-stealth-mechanics-visibility-detection-meter-c" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chapter 7.3: Stealth Mechanics - Visibility &amp; Detection Meter (C#)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter 7.3: Stealth Mechanics - Visibility &amp; Detection Meter (C#)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-the-dynamic-nature-of-stealth" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. The Dynamic Nature of Stealth
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-defining-stealthcomponent-and-detectioncomponent" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Defining StealthComponent and DetectionComponent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-implementing-stealthsystemcs" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Implementing StealthSystem.cs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-integrating-stealthsystem-into-gamemanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Integrating StealthSystem into GameManager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Integrating StealthSystem into GameManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-update-eventbuscs-for-stealth-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1. Update EventBus.cs for Stealth Events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-displaying-detection-meter-in-the-body-gdscript-ui" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Displaying Detection Meter in the Body (GDScript UI)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-testing-stealth-mechanics" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Testing Stealth Mechanics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Chapter 7.3: Stealth Mechanics - Visibility & Detection Meter (C#)</h1>

<h2 id="chapter-73-stealth-mechanics-visibility-detection-meter-c">Chapter 7.3: Stealth Mechanics - Visibility &amp; Detection Meter (C#)</h2>
<p>With our <code>PerceptionSystem</code> allowing entities to see and hear, it's time to introduce <strong>Stealth Mechanics</strong>. This chapter focuses on implementing <code>Visibility</code> as a float value for entities, influenced by factors like light level, movement speed, and (conceptually) camouflage. We'll also design a <code>Detection Meter</code> that, when filled, transitions NPCs into an "Alert" state, creating a tactical interplay between stealth and perception, as specified in TDD 05.2.3 and GDD B10.</p>
<h3 id="1-the-dynamic-nature-of-stealth">1. The Dynamic Nature of Stealth</h3>
<p>The GDD (B10.2) states: "Stealth is weak early, viable mid-game, and powerful at high mastery, but always counterable." This implies:</p>
<ul>
<li><strong>Non-Binary Stealth</strong>: Not just "hidden" or "detected," but a continuous <code>Visibility</code> score.</li>
<li><strong>Environmental Influence</strong>: Light, shadows, and terrain affect visibility.</li>
<li><strong>Player Skill</strong>: Movement control and glyphs (Veil, Echo) can reduce visibility.</li>
<li><strong>NPC Detection</strong>: NPCs accumulate "detection" over time, leading to alert states.</li>
</ul>
<h3 id="2-defining-stealthcomponent-and-detectioncomponent">2. Defining <code>StealthComponent</code> and <code>DetectionComponent</code></h3>
<p>We need components to store an entity's stealth properties (what makes it hidden) and its detection properties (how much it's currently detected).</p>
<ol>
<li>Create <code>res://_Brain/Systems/AI/StealthComponent.cs</code>:</li>
</ol>
<pre><code class="language-csharp">// _Brain/Systems/AI/StealthComponent.cs
using System;
using Godot; // For Vector2

namespace Sigilborne.Systems.AI
{
    /// &lt;summary&gt;
    /// Stores the parameters defining an entity's stealth capabilities and current visibility.
    /// (TDD 05.2.3)
    /// &lt;/summary&gt;
    public struct StealthComponent
    {
        public float BaseVisibility;    // Base visibility (1.0 = fully visible, 0.0 = invisible)
        public float MovementNoise;     // How much noise this entity generates when moving (0-1)
        public float CamouflageBonus;   // Environmental camouflage bonus (e.g., -0.2 for 20% less visible)
        public float ChakraSignatureMod; // How much this entity's chakra signature is dampened (0-1)

        public StealthComponent(float baseVisibility = 1.0f, float movementNoise = 0.5f, float camouflageBonus = 0f, float chakraSignatureMod = 0f)
        {
            BaseVisibility = baseVisibility;
            MovementNoise = movementNoise;
            CamouflageBonus = camouflageBonus;
            ChakraSignatureMod = chakraSignatureMod;
        }

        public override string ToString()
        {
            return $&quot;Vis: {BaseVisibility:F2}, Noise: {MovementNoise:F2}, Camo: {CamouflageBonus:F2}&quot;;
        }
    }
}
</code></pre>
<ol>
<li>Create <code>res://_Brain/Systems/AI/DetectionComponent.cs</code>:</li>
</ol>
<pre><code class="language-csharp">// _Brain/Systems/AI/DetectionComponent.cs
using System;
using Godot; // For Vector2

namespace Sigilborne.Systems.AI
{
    /// &lt;summary&gt;
    /// Stores an entity's current detection state by a specific perceiver.
    /// (TDD 05.2.3: Detection Meter)
    /// &lt;/summary&gt;
    public struct DetectionComponent
    {
        public EntityID PerceiverID;       // The entity doing the detecting (e.g., an NPC looking at the player)
        public float DetectionMeter;        // Accumulates detection (0-100). If &gt; Threshold, target is Alerted.
        public float MaxDetectionMeter;     // Max value of the meter (e.g., 100)
        public float DecayRate;             // How fast the meter decays when not actively detected
        public bool IsAlerted;             // True if the target is fully detected and the perceiver is alerted.

        public DetectionComponent(EntityID perceiverID, float maxDetectionMeter = 100f, float decayRate = 5f)
        {
            PerceiverID = perceiverID;
            DetectionMeter = 0;
            MaxDetectionMeter = maxDetectionMeter;
            DecayRate = decayRate;
            IsAlerted = false;
        }

        public override string ToString()
        {
            return $&quot;Det: {DetectionMeter:F1}/{MaxDetectionMeter:F0} (Alerted: {IsAlerted})&quot;;
        }
    }
}
</code></pre>
<h3 id="3-implementing-stealthsystemcs">3. Implementing <code>StealthSystem.cs</code></h3>
<p>This system will:
*   Manage <code>StealthComponent</code>s.
*   Calculate an entity's <code>CurrentVisibility</code> and <code>CurrentNoise</code> based on its state.
*   Manage <code>DetectionComponent</code>s, updating meters and triggering <code>Alerted</code> states.</p>
<ol>
<li>Create <code>res://_Brain/Systems/AI/StealthSystem.cs</code>:</li>
</ol>
<pre><code class="language-csharp">// _Brain/Systems/AI/StealthSystem.cs
using Godot;
using System;
using System.Collections.Generic;
using Sigilborne.Core;
using Sigilborne.Entities;
using Sigilborne.Entities.Components; // For TransformComponent
using Sigilborne.Systems.Biology; // For CoreStats
using Sigilborne.Systems.Movement; // For movement speed
using Sigilborne.Systems.Weather; // For light level / environmental effects
using System.Linq;

namespace Sigilborne.Systems.AI
{
    /// &lt;summary&gt;
    /// Manages stealth mechanics, including calculating entity visibility/noise and
    /// handling detection meters for perceivers.
    /// (TDD 05.2.3, GDD B10)
    /// &lt;/summary&gt;
    public class StealthSystem
    {
        private EntityManager _entityManager;
        private EventBus _eventBus;
        private TransformSystem _transformSystem;
        private BiologicalSystem _biologicalSystem; // For CoreStats (movement speed)
        private MovementSystem _movementSystem;     // For actual velocity
        private WeatherSystem _weatherSystem;       // For light level / environmental effects
        private PerceptionSystem _perceptionSystem; // To query perceivers

        // Dictionary to store StealthComponent for entities that can be stealthy.
        private Dictionary&lt;EntityID, StealthComponent&gt; _stealthComponents = new Dictionary&lt;EntityID, StealthComponent&gt;();

        // Dictionary to store DetectionComponents (perceiver -&gt; target -&gt; detection state)
        // For simplicity, we'll store per-target detection in a list on the target for now,
        // rather than per-perceiver. This means a target knows *how much* it's detected.
        private Dictionary&lt;EntityID, List&lt;DetectionComponent&gt;&gt; _targetDetectionStates = new Dictionary&lt;EntityID, List&lt;DetectionComponent&gt;&gt;();


        public StealthSystem(EntityManager entityManager, EventBus eventBus, TransformSystem transformSystem, BiologicalSystem biologicalSystem, MovementSystem movementSystem, WeatherSystem weatherSystem, PerceptionSystem perceptionSystem)
        {
            _entityManager = entityManager;
            _eventBus = eventBus;
            _transformSystem = transformSystem;
            _biologicalSystem = biologicalSystem;
            _movementSystem = movementSystem;
            _weatherSystem = weatherSystem;
            _perceptionSystem = perceptionSystem;

            _eventBus.OnEntitySpawned += OnEntitySpawned;
            _eventBus.OnEntityDespawned += OnEntityDespawned;

            GD.Print(&quot;StealthSystem: Initialized.&quot;);
        }

        private void OnEntitySpawned(EntityID id, EntityType type, string definitionID, Vector2 initialPosition, float initialRotation)
        {
            // Only add StealthComponent to entities that can be stealthy (Player, NPC, some Animals)
            if (type == EntityType.Player || type == EntityType.NPC || type == EntityType.Animal)
            {
                // Player has better base stealth
                if (type == EntityType.Player)
                {
                    _stealthComponents.Add(id, new StealthComponent(baseVisibility: 0.8f, movementNoise: 0.3f));
                }
                else // NPC / Animal
                {
                    _stealthComponents.Add(id, new StealthComponent(baseVisibility: 1.0f, movementNoise: 0.5f));
                }
                _targetDetectionStates.Add(id, new List&lt;DetectionComponent&gt;()); // Add detection states for this target
                GD.Print($&quot;StealthSystem: Added StealthComponent for {type} entity {id}.&quot;);
            }
        }

        private void OnEntityDespawned(EntityManager.EntityDespawnedEvent e)
        {
            _stealthComponents.Remove(e.ID);
            _targetDetectionStates.Remove(e.ID);
            GD.Print($&quot;StealthSystem: Removed StealthComponent for {e.ID}.&quot;);
        }

        /// &lt;summary&gt;
        /// Main update loop for the StealthSystem.
        /// Called during GameManager._PhysicsProcess (Phase 2).
        /// &lt;/summary&gt;
        public void Tick(double delta)
        {
            foreach (var kvp in _stealthComponents)
            {
                EntityID targetID = kvp.Key;
                ref StealthComponent stealth = ref _stealthComponents.GetValueRef(targetID);

                if (!_entityManager.IsValid(targetID)) continue;

                // --- Calculate Current Visibility (TDD 05.2.3) ---
                float currentVisibility = CalculateCurrentVisibility(targetID, stealth);
                // GD.Print($&quot;StealthSystem: {targetID} Current Visibility: {currentVisibility:P1}&quot;);

                // --- Update Detection Meters ---
                // For each target, iterate through all potential perceivers.
                // This is a simplified O(N*M) loop. In a real game, only relevant perceivers would update.
                // For now, let's just make the player the target and update its detection by an &quot;abstract&quot; NPC.
                if (targetID == _entityManager.GetPlayerEntityID())
                {
                    UpdatePlayerDetection(targetID, currentVisibility, delta);
                }
            }
        }

        /// &lt;summary&gt;
        /// Calculates the current effective visibility of an entity.
        /// (TDD 05.2.3: Factors: Light Level (from TileMap), Movement Speed, Camouflage)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;entityID&quot;&gt;The entity whose visibility is being calculated.&lt;/param&gt;
        /// &lt;param name=&quot;stealthComponent&quot;&gt;The entity's StealthComponent.&lt;/param&gt;
        /// &lt;returns&gt;A float from 0.0 (invisible) to 1.0 (fully visible).&lt;/returns&gt;
        private float CalculateCurrentVisibility(EntityID entityID, StealthComponent stealthComponent)
        {
            float visibility = stealthComponent.BaseVisibility;

            // 1. Movement Speed (TDD 05.2.3)
            if (_movementSystem.TryGetCoreStats(entityID, out CoreStats coreStats))
            {
                Vector2 velocity = _movementSystem.GetVelocity(entityID);
                float speedRatio = velocity.Length() / coreStats.MoveSpeed; // 0 for idle, 1 for max speed
                visibility += speedRatio * stealthComponent.MovementNoise; // Moving faster increases visibility
            }

            // 2. Light Level (from WeatherSystem, conceptual local light) (TDD 05.2.3)
            // if (_transformSystem.TryGetTransform(entityID, out TransformComponent transform))
            // {
            //     float lightLevel = _weatherSystem.GetLightLevelAt(transform.Position); // Conceptual
            //     visibility *= lightLevel; // Darker areas reduce visibility
            // }

            // 3. Camouflage Bonus (TDD 05.2.3)
            visibility += stealthComponent.CamouflageBonus; // Negative bonus reduces visibility

            // Later: Chakra signature (GDD B10.3.B)
            // visibility += stealthComponent.ChakraSignatureMod * _biologicalSystem.GetChakraSignatureStrength(entityID);

            return Mathf.Clamp(visibility, 0f, 1f);
        }

        /// &lt;summary&gt;
        /// Calculates the current effective noise generated by an entity.
        /// &lt;/summary&gt;
        public float CalculateCurrentNoise(EntityID entityID, StealthComponent stealthComponent)
        {
            if (!_biologicalSystem.TryGetCoreStats(entityID, out CoreStats coreStats)) return 0;
            Vector2 velocity = _movementSystem.GetVelocity(entityID);
            float speedRatio = velocity.Length() / coreStats.MoveSpeed;
            return stealthComponent.MovementNoise * speedRatio;
        }

        /// &lt;summary&gt;
        /// Updates the player's detection meter by an abstract NPC perceiver.
        /// (TDD 05.2.3: Detection Meter)
        /// &lt;/summary&gt;
        private void UpdatePlayerDetection(EntityID playerID, float playerVisibility, double delta)
        {
            // For testing, let's use a dummy NPC perceiver.
            // In a real game, this would loop through actual NPCs perceiving the player.
            EntityID dummyNpcID = GameManager.Instance.Entities.GetEntityMeta(1).Generation == 1 ? new EntityID(1, 1) : EntityID.Invalid;
            if (!dummyNpcID.IsValid()) return;

            // Find or create the detection component for this perceiver-target pair
            List&lt;DetectionComponent&gt; detections = _targetDetectionStates[playerID];
            int detectionIndex = detections.FindIndex(d =&gt; d.PerceiverID == dummyNpcID);

            if (detectionIndex == -1)
            {
                // Create a new detection entry if none exists for this perceiver
                detections.Add(new DetectionComponent(dummyNpcID));
                detectionIndex = detections.Count - 1;
            }

            ref DetectionComponent playerDetection = ref detections.GetValueRef(detectionIndex);

            // --- Detection Meter Logic ---
            // If the player is 'seen' by the dummy NPC (conceptual)
            bool isPlayerCurrentlySeen = _perceptionSystem.CanSee(dummyNpcID, playerID); // Use NPC's vision to see player

            if (isPlayerCurrentlySeen)
            {
                // Increase detection meter based on player's visibility and perceiver's sensitivity
                float detectionGain = playerVisibility * _perceptionSystem.GetPerceptionComponentRef(dummyNpcID).VisionRange * 0.05f * (float)delta; // Gain faster if more visible
                playerDetection.DetectionMeter += detectionGain;
                // GD.Print($&quot;StealthSystem: {dummyNpcID} gains detection on {playerID}. Gain: {detectionGain:F2}. Current: {playerDetection.DetectionMeter:F1}&quot;);
            }
            else
            {
                // Decay detection meter if not currently seen
                playerDetection.DetectionMeter -= playerDetection.DecayRate * (float)delta;
            }

            playerDetection.DetectionMeter = Mathf.Clamp(playerDetection.DetectionMeter, 0f, playerDetection.MaxDetectionMeter);

            // Check for alert state transition (TDD 05.2.3)
            if (playerDetection.DetectionMeter &gt;= playerDetection.MaxDetectionMeter * 0.8f &amp;&amp; !playerDetection.IsAlerted) // 80% to alert
            {
                playerDetection.IsAlerted = true;
                GD.Print($&quot;StealthSystem: Player {playerID} is now ALERTED by {dummyNpcID}!&quot;);
                _eventBus.Publish(new PlayerAlertedEvent { PlayerID = playerID, PerceiverID = dummyNpcID, IsAlerted = true });
            }
            else if (playerDetection.DetectionMeter &lt; playerDetection.MaxDetectionMeter * 0.5f &amp;&amp; playerDetection.IsAlerted) // Drop below 50% to de-alert
            {
                playerDetection.IsAlerted = false;
                GD.Print($&quot;StealthSystem: Player {playerID} is no longer ALERTED by {dummyNpcID}.&quot;);
                _eventBus.Publish(new PlayerAlertedEvent { PlayerID = playerID, PerceiverID = dummyNpcID, IsAlerted = false });
            }

            // Publish event for UI (e.g., stealth meter, alert indicator)
            _eventBus.Publish(new PlayerDetectionUpdatedEvent { PlayerID = playerID, DetectionMeter = playerDetection.DetectionMeter, MaxDetectionMeter = playerDetection.MaxDetectionMeter, IsAlerted = playerDetection.IsAlerted });
        }


        // --- Helper Events for Body Sync ---
        public struct PlayerDetectionUpdatedEvent { public EntityID PlayerID; public float DetectionMeter; public float MaxDetectionMeter; public bool IsAlerted; }
        public struct PlayerAlertedEvent { public EntityID PlayerID; public EntityID PerceiverID; public bool IsAlerted; }
    }
}
</code></pre>
<h3 id="4-integrating-stealthsystem-into-gamemanager">4. Integrating <code>StealthSystem</code> into <code>GameManager</code></h3>
<ol>
<li>Add <code>using Sigilborne.Systems.AI;</code> at the top of <code>_Brain/Core/GameManager.cs</code>.</li>
<li>Add a <code>StealthSystem</code> property.</li>
<li>Initialize <code>StealthSystem</code> in <code>InitializeSystems()</code> <strong>after</strong> <code>PerceptionSystem</code>.</li>
<li>Call <code>StealthSystem.Tick(delta)</code> in <code>_PhysicsProcess</code> (Phase 2).</li>
</ol>
<pre><code class="language-csharp">// _Brain/Core/GameManager.cs
using Godot;
using System;
using Sigilborne.Core;
using Sigilborne.Entities;
using Sigilborne.Systems;
using Sigilborne.Systems.Biology;
using Sigilborne.Systems.Input;
using Sigilborne.Systems.Movement;
using Sigilborne.Systems.Physics;
using Sigilborne.Systems.Magic;
using Sigilborne.Systems.Weather;
using Sigilborne.Systems.StatusEffects;
using Sigilborne.Systems.Combat;
using Sigilborne.Systems.Inventory;
using Sigilborne.Systems.AI;
using Sigilborne.Utils;
using System.Linq;
using Sigilborne.Systems.Magic.Components;

public partial class GameManager : Node
{
    public static GameManager Instance { get; private set; }

    // ... (existing system properties) ...
    public PerceptionSystem Perception { get; private set; }
    public StealthSystem Stealth { get; private set; } // Add StealthSystem property

    public override void _Ready()
    {
        // ... (existing Instance check and InitializeSystems call) ...
        // ... (existing test entity/job code) ...
        // ... (existing glyph and magic system tests) ...
        // ... (existing damage tests) ...
        // ... (existing inventory/equipment tests) ...
        // ... (existing spatial grid tests) ...
        // ... (existing perception system tests) ...

        // --- Test Stealth System ---
        GD.Print(&quot;\n--- Testing Stealth System ---&quot;);
        EntityID playerID = Entities.GetPlayerEntityID();
        EntityID testNpcID = Entities.GetEntityMeta(1).Generation == 1 ? new EntityID(1, 1) : EntityID.Invalid; // Assuming NPC is ID 1, Gen 1

        if (playerID.IsValid() &amp;&amp; testNpcID.IsValid())
        {
            // Place player and NPC close for detection. Player is facing NPC.
            Transforms.GetTransformRef(playerID).Position = new Vector2(200, 200);
            Transforms.GetTransformRef(testNpcID).Position = new Vector2(250, 200);
            Transforms.GetTransformRef(playerID).RotationDegrees = 0; // Face right

            GD.Print($&quot;Player {playerID} initial stealth: {Stealth.GetStealthComponentRef(playerID)}&quot;);
            GD.Print($&quot;NPC {testNpcID} initial perception: {Perception.GetPerceptionComponentRef(testNpcID)}&quot;);
        }
        else
        {
            GD.PrintErr(&quot;Player or Test NPC not valid for stealth tests.&quot;);
        }

        GD.Print(&quot;--- End Testing Stealth System ---\n&quot;);
    }

    public override void _PhysicsProcess(double delta)
    {
        Input.ProcessInputBuffer(); 
        Time.Tick(delta);
        World.Tick(delta);
        Movement.Tick(delta);
        Magic.Tick(delta);
        Casting.Tick(delta);
        Weather.Tick(delta);
        Biology.Tick(delta);
        TitanAI.Tick(delta);
        StatusEffects.Tick(delta);
        Perception.Tick(delta); // PerceptionSystem needs to tick if it's continuously querying, or query here.
        Stealth.Tick(delta); // Call StealthSystem's tick method
        Events.FlushCommands();
    }

    private void InitializeSystems()
    {
        // ... (existing system initializations up to PerceptionSystem) ...

        // Initialize StealthSystem AFTER PerceptionSystem and other dependencies
        Stealth = new StealthSystem(Entities, Events, Transforms, BiologicalSystem, Movement, Weather, Perception); // Pass dependencies
        GD.Print(&quot;  - StealthSystem initialized.&quot;);

        // ... (existing system initializations after StealthSystem) ...
    }
}
</code></pre>
<h4 id="41-update-eventbuscs-for-stealth-events">4.1. Update <code>EventBus.cs</code> for Stealth Events</h4>
<p>Open <code>res://_Brain/Core/EventBus.cs</code> and add <code>OnPlayerDetectionUpdated</code> and <code>OnPlayerAlerted</code> delegates.</p>
<pre><code class="language-csharp">// _Brain/Core/EventBus.cs
using System;
using System.Collections.Concurrent;
using Godot;
using Sigilborne.Entities;
using Sigilborne.Systems.Biology;
using Sigilborne.Systems.Magic;
using Sigilborne.Systems.StatusEffects;
using Sigilborne.Systems.Combat;
using Sigilborne.Systems.Inventory;
using Sigilborne.Systems.AI; // Add this using directive
using System.Collections.Generic;

namespace Sigilborne.Core
{
    public class EventBus
    {
        // ... (existing events) ...

        // Stealth System Events (TDD 05.2.3)
        public event Action&lt;EntityID, float, float, bool&gt; OnPlayerDetectionUpdated; // PlayerID, DetectionMeter, MaxDetectionMeter, IsAlerted
        public event Action&lt;EntityID, EntityID, bool&gt; OnPlayerAlerted; // PlayerID, PerceiverID, IsAlerted

        // ... (existing _commandBuffer) ...

        public void Publish&lt;TEvent&gt;(TEvent eventData)
        {
            // ... (existing publish conditions) ...
            else if (eventData is StealthSystem.PlayerDetectionUpdatedEvent detectionEvent) // New condition
            {
                OnPlayerDetectionUpdated?.Invoke(detectionEvent.PlayerID, detectionEvent.DetectionMeter, detectionEvent.MaxDetectionMeter, detectionEvent.IsAlerted);
            }
            else if (eventData is StealthSystem.PlayerAlertedEvent alertedEvent) // New condition
            {
                OnPlayerAlerted?.Invoke(alertedEvent.PlayerID, alertedEvent.PerceiverID, alertedEvent.IsAlerted);
            }
            else
            {
                GD.PrintErr($&quot;EventBus: Attempted to publish unknown event type: {typeof(TEvent).Name}. Ensure it's handled in Publish&lt;TEvent&gt;.&quot;);
            }
        }
        // ... (AddCommand and FlushCommands methods) ...
    }
}
</code></pre>
<h3 id="5-displaying-detection-meter-in-the-body-gdscript-ui">5. Displaying Detection Meter in the Body (GDScript UI)</h3>
<p>Let's add a simple UI to display the player's detection meter.</p>
<ol>
<li>
<p>Open <code>res://_Body/Scenes/UI/HUD.tscn</code> and modify it:</p>
<ul>
<li>Add a <code>Label</code> node for <code>DetectionLabel</code>.</li>
<li>Arrange it (e.g., in <code>VBoxNeeds</code>).</li>
</ul>
</li>
<li>
<p>Open <code>res://_Body/Scripts/UI/HUDController.gd</code> and modify it:</p>
</li>
</ol>
<pre><code class="language-gdscript"># _Body/Scripts/UI/HUDController.gd
class_name HUDController extends CanvasLayer

@onready var health_label: Label = $MainHBox/VBoxStats/HealthLabel
@onready var chakra_label: Label = $MainHBox/VBoxStats/ChakraLabel
@onready var stamina_label: Label = $MainHBox/VBoxStats/StaminaLabel
@onready var stability_label: Label = $MainHBox/VBoxStats/StabilityLabel
@onready var hunger_label: Label = $MainHBox/VBoxNeeds/HungerLabel
@onready var thirst_label: Label = $MainHBox/VBoxNeeds/ThirstLabel
@onready var weather_label: Label = $MainHBox/VBoxNeeds/WeatherLabel
@onready var temperature_label: Label = $MainHBox/VBoxNeeds/TemperatureLabel
@onready var detection_label: Label = $MainHBox/VBoxNeeds/DetectionLabel # New

var player_entity_id: int = -1

func _ready():
    GD.print(&quot;HUDController: Initialized. Connecting to C# PlayerStatSystem &amp; BiologicalSystem events.&quot;)
    if GameManager.Instance != null and GameManager.Instance.Events != null:
        # ... (existing event connections) ...
        GameManager.Instance.Events.OnPlayerDetectionUpdated.connect(Callable(self, &quot;_on_player_detection_updated&quot;)) # New
        GameManager.Instance.Events.OnPlayerAlerted.connect(Callable(self, &quot;_on_player_alerted&quot;)) # New
        GD.print(&quot;HUDController: Successfully connected to C# PlayerStatSystem &amp; BiologicalSystem events.&quot;)
    else:
        push_error(&quot;HUDController: GameManager or EventBus not ready! Cannot connect C# events.&quot;)

func _on_entity_spawned(id: int, type: int, definition_id: String, initial_position: Vector2, initial_rotation: float) -&gt; void:
    if type == 0:
        player_entity_id = id
        GD.print(&quot;HUDController: Detected player entity with ID: %s&quot; % player_entity_id)

# ... (existing stat update handlers) ...

## Handler for C# OnPlayerDetectionUpdated event.
func _on_player_detection_updated(id: int, detection_meter: float, max_detection_meter: float, is_alerted: bool) -&gt; void:
    if id == player_entity_id:
        var alert_status = &quot;Hidden&quot;
        if is_alerted:
            alert_status = &quot;ALERTED!&quot;
        elif detection_meter &gt; max_detection_meter * 0.5:
            alert_status = &quot;Suspicious&quot;
        elif detection_meter &gt; 0:
            alert_status = &quot;Detected&quot;

        detection_label.text = &quot;DET: %s/%s (%s)&quot; % [int(detection_meter), int(max_detection_meter), alert_status]

## Handler for C# OnPlayerAlerted event.
func _on_player_alerted(id: int, perceiver_id: int, is_alerted: bool) -&gt; void:
    if id == player_entity_id:
        GD.print(&quot;HUDController: Player %s is now %s by Perceiver %s!&quot; % [id, &quot;ALERTED&quot; if is_alerted else &quot;NOT ALERTED&quot;, perceiver_id])
        # Play a sound, flash screen, etc.
</code></pre>
<h3 id="6-testing-stealth-mechanics">6. Testing Stealth Mechanics</h3>
<ol>
<li>Save all C# and GDScript files.</li>
<li>Run <code>Main.tscn</code>.</li>
<li>Load <code>Gameplay.tscn</code>.</li>
<li>Observe the new Detection label on the HUD.<ul>
<li><strong>Initial State</strong>: The player starts near an NPC. The detection meter should slowly increase as the NPC "sees" the player.</li>
<li><strong>Alerted</strong>: Once the meter reaches 80, it should switch to "ALERTED!".</li>
<li><strong>Movement</strong>: Move the player. The detection gain should be higher because <code>playerVisibility</code> increases with movement speed.</li>
<li><strong>Decay</strong>: Stand still. The detection meter should slowly decay. If it drops below 50, the "ALERTED!" status should clear.</li>
<li><strong>Hide</strong>: Move the player far away from the NPC (e.g., to 1000,1000 using WASD). The detection meter should quickly decay to 0.</li>
</ul>
</li>
</ol>
<p>This confirms that the <code>StealthSystem</code> is correctly calculating <code>Visibility</code> based on movement and managing the <code>Detection Meter</code>, providing dynamic feedback on the player's stealth status.</p>
<h3 id="summary">Summary</h3>
<p>You have successfully implemented <strong>Stealth Mechanics</strong> in the C# Brain, designing <code>StealthComponent</code> and <code>DetectionComponent</code> to manage entity visibility and detection states. By creating <code>StealthSystem</code> to calculate <code>CurrentVisibility</code> based on movement and managing <code>DetectionMeter</code> accumulation and decay, you've established a dynamic and tactical interplay between stealth and perception. This crucial system strictly adheres to TDD 05.2.3 and GDD B10's specifications, providing continuous feedback on the player's stealth status and driving NPC alert states.</p>
<h3 id="next-steps">Next Steps</h3>
<p>The next chapter will focus on <strong>Decision Making: Utility AI (C#)</strong>, where we will design a flexible Utility AI system for NPCs, allowing them to select actions (e.g., attack, flee, eat, sleep) based on a scoring mechanism that evaluates their needs and environmental context.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.sections", "navigation.expand", "content.code.copy"], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>