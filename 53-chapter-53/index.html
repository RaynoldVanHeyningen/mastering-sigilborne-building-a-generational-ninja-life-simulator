
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../52-chapter-52/">
      
      
        <link rel="next" href="../54-chapter-54/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Chapter 8.4: Trade Routes - Caravans as Arteries (C#) - Mastering Sigilborne: Building a Generational Ninja Life Simulator</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="sky" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapter-84-trade-routes-caravans-as-arteries-c" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Mastering Sigilborne: Building a Generational Ninja Life Simulator" class="md-header__button md-logo" aria-label="Mastering Sigilborne: Building a Generational Ninja Life Simulator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Mastering Sigilborne: Building a Generational Ninja Life Simulator
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chapter 8.4: Trade Routes - Caravans as Arteries (C#)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Mastering Sigilborne: Building a Generational Ninja Life Simulator" class="md-nav__button md-logo" aria-label="Mastering Sigilborne: Building a Generational Ninja Life Simulator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Mastering Sigilborne: Building a Generational Ninja Life Simulator
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../01-chapter-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.1: Project Setup for Godot 4.5 with C#
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../02-chapter-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.2: The Brain (C#) - Headless Simulation Layer
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../03-chapter-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.3: The Body (GDScript) - Reactive Presentation Layer
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../04-chapter-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.4: Directory Structure - Enforcing Separation of Concerns
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../05-chapter-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.5: Entity Model - Lightweight ECS-lite in C#
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../06-chapter-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.6: Component Architecture - Composition over Inheritance
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../07-chapter-7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.7: Job System & Concurrency - Multithreaded Processing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../08-chapter-8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.8: Thread Safety - Command Buffers & Double Buffering
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../09-chapter-9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.9: Scene Composition - Standardizing Godot Scenes
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../10-chapter-10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.10: Naming Conventions & Scene Interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../11-chapter-11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.11: Animation Event Protocol - Syncing Brain & Body
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../12-chapter-12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.12: Interop Layer - C# to GDScript Communication
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../13-chapter-13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.13: Global State Management - Data Ownership
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../14-chapter-14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.14: Debugging Tools - Console & State Inspector
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../15-chapter-15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 1.15: Main Loop Execution Order - Tick vs. Frame
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../16-chapter-16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 2.1: Input Manager - Capturing Raw Input (GDScript)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../17-chapter-17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 2.2: Standard Movement Logic - Velocity & Friction (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../18-chapter-18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 2.3: Shift-Sliding Mechanic - Direction Lock (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../19-chapter-19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 2.4: Physics Layer - Hybrid Movement Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../20-chapter-20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3.1: Glyph Database - Concepts vs. Symbols (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../21-chapter-21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3.2: Glyph Discovery System - Player Knowledge State (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../22-chapter-22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3.3: Glyph Experimentation - Trial & Error Casting (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../23-chapter-23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3.4: Subtypes & Modifiers - Procedural Nuance for Glyphs (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../24-chapter-24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 3.5: Glyph Acquisition - Teachers & Scrolls (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../25-chapter-25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4.1: Input Buffer - Storing Glyph Sequences (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../26-chapter-26/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4.2: Combo Resolver - Trie Structure for Spell Detection (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../27-chapter-27/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4.3: Spell Data Architecture - Data-Driven Definitions (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../28-chapter-28/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4.4: Casting State Machine - Player Casting Flow (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../29-chapter-29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 4.5: Visual Feedback - Particles & Animations (GDScript)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../30-chapter-30/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.1: Biological Simulation - The Bio-Tick (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../31-chapter-31/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.2: Core Stats (Struct)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../32-chapter-32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.3: Metabolism System - Dynamic Decay Rates (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../33-chapter-33/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.4: Weather & Environment - Global Environmental State (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../34-chapter-34/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.5: Damage & Recovery Pipeline - Wounds & Status Effects (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../35-chapter-35/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.6: Status Effect Data - Definition vs. Instance (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../36-chapter-36/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.7: Recovery Logic - Health, Stamina, Chakra Regeneration (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../37-chapter-37/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 5.8: Weather & Environment - Global Environmental State (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../38-chapter-38/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.1: Physics Layer - Hitbox & Hurtbox Detection (GDScript)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../39-chapter-39/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.2: The Math Layer - Damage Calculator (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../40-chapter-40/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.3: Equipment & Inventory - Inventory Data Structure (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../41-chapter-41/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.4: Equipment Logic - Recalculating Stats (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../42-chapter-42/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.5: World Boss Mechanics - Multi-Part Entities (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../43-chapter-43/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 6.6: Titan AI State - Specialized State Machine (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../44-chapter-44/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.1: Perception System - Spatial Hashing (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../45-chapter-45/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.2: The Senses - Vision, Hearing & Chakra Sense (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../46-chapter-46/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.3: Stealth Mechanics - Visibility & Detection Meter (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../47-chapter-47/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.4: Decision Making: Utility AI (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../48-chapter-48/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.5: Ecology Simulation - Virtual Agents (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../49-chapter-49/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 7.6: Spawning & Despawning - Hydration/Dehydration (Brain & Body)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../50-chapter-50/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.1: Faction System - The Relationship Graph (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../51-chapter-51/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.2: The Simulation Clock - Game Time & Load Balancing (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../52-chapter-52/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.3: Market Simulation - Supply & Demand (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.4: Trade Routes - Caravans as Arteries (C#)
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.4: Trade Routes - Caravans as Arteries (C#)
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chapter-84-trade-routes-caravans-as-arteries-c" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chapter 8.4: Trade Routes - Caravans as Arteries (C#)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter 8.4: Trade Routes - Caravans as Arteries (C#)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-the-dynamic-nature-of-trade" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. The Dynamic Nature of Trade
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-defining-caravan-and-caravanroute" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Defining Caravan and CaravanRoute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-enhancing-economymanagercs-for-trade-routes" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Enhancing EconomyManager.cs for Trade Routes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-integrating-economymanager-into-gamemanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Integrating EconomyManager into GameManager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Integrating EconomyManager into GameManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-update-eventbuscs-for-caravan-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1. Update EventBus.cs for Caravan Events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-testing-trade-routes-and-caravans" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Testing Trade Routes and Caravans
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../54-chapter-54/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.5: Crime & Justice - The Heat System (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../55-chapter-55/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 8.6: Bounty & Punishment - Escalation & Consequences (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../56-chapter-56/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9.1: Ritual System - Pattern Matching & Execution (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../57-chapter-57/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9.2: Seals & Locks - Logical Locks (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../58-chapter-58/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9.3: Ritual System - Simple, Advanced & Forbidden (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../59-chapter-59/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9.4: Forbidden Contracts & Spirit Contracts (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../60-chapter-60/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapter 9.5: Corruption Pacts & Multi-Life Persistence of Rituals (C#)
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chapter-84-trade-routes-caravans-as-arteries-c" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chapter 8.4: Trade Routes - Caravans as Arteries (C#)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter 8.4: Trade Routes - Caravans as Arteries (C#)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-the-dynamic-nature-of-trade" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. The Dynamic Nature of Trade
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-defining-caravan-and-caravanroute" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Defining Caravan and CaravanRoute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-enhancing-economymanagercs-for-trade-routes" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Enhancing EconomyManager.cs for Trade Routes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-integrating-economymanager-into-gamemanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Integrating EconomyManager into GameManager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Integrating EconomyManager into GameManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-update-eventbuscs-for-caravan-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1. Update EventBus.cs for Caravan Events
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-testing-trade-routes-and-caravans" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Testing Trade Routes and Caravans
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Chapter 8.4: Trade Routes - Caravans as Arteries (C#)</h1>

<h2 id="chapter-84-trade-routes-caravans-as-arteries-c">Chapter 8.4: Trade Routes - Caravans as Arteries (C#)</h2>
<p>Our <code>EconomyManager</code> now simulates local markets and dynamic prices. The next crucial component of the economic system is <strong>Trade Routes</strong>, represented by NPC caravans physically moving between settlements. This chapter designs how these caravans operate, carry goods, and how their journeys can be interrupted by player actions or world events, directly influencing supply chains and local market prices, as specified in TDD 06.3.2.</p>
<h3 id="1-the-dynamic-nature-of-trade">1. The Dynamic Nature of Trade</h3>
<p>The GDD (B23.4) states: "Caravans travel between settlements carrying... goods... Each caravan has a faction identity, a risk rating, preferred routes, defenses, negotiable prices, vulnerabilities." This implies:</p>
<ul>
<li><strong>Physical Movement</strong>: Caravans are entities that move in the world.</li>
<li><strong>Goods Flow</strong>: They transport items, affecting supply/demand in origin/destination markets.</li>
<li><strong>Vulnerability</strong>: They can be attacked, robbed, or destroyed.</li>
<li><strong>Dynamic Routes</strong>: Routes can change due to world instability.</li>
<li><strong>Player Interaction</strong>: Players can escort, attack, or trade with caravans.</li>
</ul>
<h3 id="2-defining-caravan-and-caravanroute">2. Defining <code>Caravan</code> and <code>CaravanRoute</code></h3>
<p>We need a class to represent a single caravan entity and a class to define its route.</p>
<ol>
<li>Create <code>res://_Brain/Systems/Economy/CaravanData.cs</code>:</li>
</ol>
<pre><code class="language-csharp">// _Brain/Systems/Economy/CaravanData.cs
using System;
using System.Collections.Generic;
using Godot; // For Vector2
using Sigilborne.Entities; // For EntityID
using Sigilborne.Systems.Factions; // For Faction
using Sigilborne.Systems.Inventory; // For InventoryItem

namespace Sigilborne.Systems.Economy
{
    /// &lt;summary&gt;
    /// Represents a single trade caravan moving between settlements.
    /// (TDD 06.3.2)
    /// &lt;/summary&gt;
    public class Caravan
    {
        public EntityID ID { get; private set; } // The entity ID of this caravan
        public string Name { get; private set; }
        public string OriginSettlementID { get; private set; }
        public string DestinationSettlementID { get; private set; }
        public string FactionID { get; private set; } // The faction this caravan belongs to
        public List&lt;InventoryItem&gt; Cargo { get; private set; } // The goods being transported
        public CaravanRoute CurrentRoute { get; private set; }
        public float Speed { get; private set; }
        public float CurrentProgress { get; private set; } // 0.0 to 1.0 along the route
        public bool IsDestroyed { get; private set; }
        public bool IsActive { get; private set; } // True if currently moving in the world

        public Caravan(EntityID id, string name, string originID, string destinationID, string factionID, CaravanRoute route, float speed, List&lt;InventoryItem&gt; cargo = null)
        {
            ID = id;
            Name = name;
            OriginSettlementID = originID;
            DestinationSettlementID = destinationID;
            FactionID = factionID;
            CurrentRoute = route;
            Speed = speed;
            Cargo = cargo ?? new List&lt;InventoryItem&gt;();
            CurrentProgress = 0f;
            IsDestroyed = false;
            IsActive = true;
        }

        public override string ToString()
        {
            return $&quot;Caravan: '{Name}' ({ID}) | {OriginSettlementID} -&gt; {DestinationSettlementID} | Progress: {CurrentProgress:P0}&quot;;
        }
    }

    /// &lt;summary&gt;
    /// Defines a geographical path between two settlements for a caravan.
    /// &lt;/summary&gt;
    public class CaravanRoute
    {
        public string ID { get; private set; } // Unique route ID
        public string OriginSettlementID { get; private set; }
        public string DestinationSettlementID { get; private set; }
        public float Length { get; private set; } // Total length of the route
        public List&lt;Vector2&gt; Waypoints { get; private set; } // The path the caravan follows

        public CaravanRoute(string id, string originID, string destinationID, List&lt;Vector2&gt; waypoints)
        {
            ID = id;
            OriginSettlementID = originID;
            DestinationSettlementID = destinationID;
            Waypoints = waypoints ?? new List&lt;Vector2&gt;();
            Length = CalculateLength(waypoints); // Calculate total length
        }

        private float CalculateLength(List&lt;Vector2&gt; waypoints)
        {
            float totalLength = 0f;
            for (int i = 0; i &lt; waypoints.Count - 1; i++)
            {
                totalLength += waypoints[i].DistanceTo(waypoints[i+1]);
            }
            return totalLength;
        }

        /// &lt;summary&gt;
        /// Gets the world position along the route at a given progress (0.0 to 1.0).
        /// &lt;/summary&gt;
        public Vector2 GetPositionAtProgress(float progress)
        {
            if (Waypoints.Count &lt; 2 || progress &lt; 0 || progress &gt; 1) return Waypoints.FirstOrDefault();

            float targetDistance = Length * progress;
            float currentDistance = 0f;

            for (int i = 0; i &lt; Waypoints.Count - 1; i++)
            {
                float segmentLength = Waypoints[i].DistanceTo(Waypoints[i+1]);
                if (currentDistance + segmentLength &gt;= targetDistance)
                {
                    // The target position is within this segment
                    float segmentProgress = (targetDistance - currentDistance) / segmentLength;
                    return Waypoints[i].Lerp(Waypoints[i+1], segmentProgress);
                }
                currentDistance += segmentLength;
            }
            return Waypoints.LastOrDefault(); // Should be reached at progress 1.0
        }

        public override string ToString()
        {
            return $&quot;Route: '{ID}' | {OriginSettlementID} -&gt; {DestinationSettlementID} | Length: {Length:F0}&quot;;
        }
    }
}
</code></pre>
<h3 id="3-enhancing-economymanagercs-for-trade-routes">3. Enhancing <code>EconomyManager.cs</code> for Trade Routes</h3>
<p><code>EconomyManager</code> will now:
*   Manage a collection of <code>CaravanRoute</code>s and <code>Caravan</code> entities.
*   Implement <code>CaravanSystem.Depart()</code> (TDD 06.2.3) logic to spawn caravans.
*   Update <code>Caravan</code> progress and position.
*   Handle <code>Caravan</code> destruction and its economic impact.</p>
<ol>
<li>Open <code>res://_Brain/Systems/Economy/EconomyManager.cs</code>.</li>
<li>Add dictionaries for <code>CaravanRoute</code>s and <code>Caravan</code> entities.</li>
<li>Implement <code>AddCaravanRoute</code>, <code>SpawnCaravan</code>, and a <code>Tick</code> method for caravans.</li>
<li>Modify <code>UpdateAllMarkets</code> to factor in caravan status.</li>
</ol>
<pre><code class="language-csharp">// _Brain/Systems/Economy/EconomyManager.cs
using Godot;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using Sigilborne.Core;
using Sigilborne.Entities;
using Sigilborne.Systems.Inventory;
using Sigilborne.Systems.Factions;
using Sigilborne.Systems.Movement; // For caravan movement via TransformSystem
using System.Linq;

namespace Sigilborne.Systems.Economy
{
    // ... (MarketRecord, SettlementMarket structs/classes) ...

    /// &lt;summary&gt;
    /// Manages the economic simulation: local markets, supply &amp; demand, and price fluctuations.
    /// Now also manages trade routes and caravans.
    /// (TDD 06.3)
    /// &lt;/summary&gt;
    public class EconomyManager
    {
        private EventBus _eventBus;
        private EquipmentSystem _equipmentSystem;
        private FactionSystem _factionSystem;
        private EntityManager _entityManager; // New: For spawning caravan entities
        private TransformSystem _transformSystem; // New: For updating caravan positions

        private Dictionary&lt;string, SettlementMarket&gt; _activeMarkets = new Dictionary&lt;string, SettlementMarket&gt;();
        private Dictionary&lt;string, float&gt; _globalModifiers = new Dictionary&lt;string, float&gt;();

        // New: Trade route and caravan management
        private Dictionary&lt;string, CaravanRoute&gt; _caravanRoutes = new Dictionary&lt;string, CaravanRoute&gt;();
        private Dictionary&lt;EntityID, Caravan&gt; _activeCaravans = new Dictionary&lt;EntityID, Caravan&gt;(); // Active caravan entities

        private const float MARKET_UPDATE_INTERVAL = 60.0f; // Update markets every 60 game minutes (1 real minute)
        private float _marketUpdateTimer;

        private const float CARAVAN_SPAWN_INTERVAL = 120.0f; // Try to spawn a caravan every 120 game minutes (2 real minutes)
        private float _caravanSpawnTimer;

        public EconomyManager(EventBus eventBus, EquipmentSystem equipmentSystem, FactionSystem factionSystem, EntityManager entityManager, TransformSystem transformSystem) // Add EntityManager, TransformSystem
        {
            _eventBus = eventBus;
            _equipmentSystem = equipmentSystem;
            _factionSystem = factionSystem;
            _entityManager = entityManager;
            _transformSystem = transformSystem;

            _eventBus.OnNewHour += OnNewHour;
            _eventBus.OnEntityDefeated += OnEntityDefeated; // To detect caravan destruction

            GD.Print(&quot;EconomyManager: Initialized.&quot;);
        }

        private void OnNewHour(int hour)
        {
            _marketUpdateTimer += (float)GameManager.Instance.Time.REAL_SECONDS_PER_GAME_MINUTE * 60; // Add 60 seconds (1 game hour)
            if (_marketUpdateTimer &gt;= MARKET_UPDATE_INTERVAL)
            {
                UpdateAllMarkets();
                _marketUpdateTimer = 0;
            }
        }

        private void OnEntityDefeated(EntityID entityID, EntityID killerID)
        {
            if (_activeCaravans.ContainsKey(entityID))
            {
                Caravan destroyedCaravan = _activeCaravans[entityID];
                destroyedCaravan.IsDestroyed = true; // Mark as destroyed
                destroyedCaravan.IsActive = false;
                GD.Print($&quot;EconomyManager: Caravan '{destroyedCaravan.Name}' ({entityID}) was destroyed by {killerID}!&quot;);

                // --- Economic Impact of Caravan Destruction --- (TDD 06.3.2)
                // Reduce supply in destination market
                SettlementMarket destinationMarket = GetMarket(destroyedCaravan.DestinationSettlementID);
                if (destinationMarket != null)
                {
                    foreach (var item in destroyedCaravan.Cargo)
                    {
                        MarketRecord record = destinationMarket.GetMarketRecord(item.ItemID);
                        record.CurrentSupply -= item.Quantity; // Reduce supply for lost cargo
                        destinationMarket.AddOrUpdateItem(record);
                    }
                }
                // Increase demand for missing items
                // Increase prices in destination market
                // Reduce reputation with faction

                _activeCaravans.Remove(entityID); // Remove from active list
                _eventBus.Publish(new CaravanDestroyedEvent { CaravanID = entityID, KillerID = killerID, CaravanName = destroyedCaravan.Name });
            }
        }

        /// &lt;summary&gt;
        /// Main update loop for the EconomyManager.
        /// Called during GameManager._PhysicsProcess (Phase 2).
        /// &lt;/summary&gt;
        public void Tick(double delta)
        {
            _caravanSpawnTimer += (float)delta;
            if (_caravanSpawnTimer &gt;= CARAVAN_SPAWN_INTERVAL)
            {
                TrySpawnCaravan();
                _caravanSpawnTimer = 0;
            }

            UpdateActiveCaravans(delta); // Update position of active caravans
        }

        /// &lt;summary&gt;
        /// Adds a new settlement market to the economy.
        /// &lt;/summary&gt;
        public void AddSettlementMarket(string settlementID, string controllingFactionID)
        {
            // ... (existing logic) ...
        }

        /// &lt;summary&gt;
        /// Adds a new trade route to the economy.
        /// &lt;/summary&gt;
        public void AddCaravanRoute(CaravanRoute route)
        {
            if (_caravanRoutes.ContainsKey(route.ID)) return;
            _caravanRoutes.Add(route.ID, route);
            GD.Print($&quot;EconomyManager: Added trade route '{route.ID}': {route.OriginSettlementID} to {route.DestinationSettlementID}.&quot;);
        }

        /// &lt;summary&gt;
        /// Tries to spawn a new caravan on an available route.
        /// (TDD 06.2.3: CaravanSystem.Depart())
        /// &lt;/summary&gt;
        private void TrySpawnCaravan()
        {
            if (_caravanRoutes.Count == 0 || _activeMarkets.Count &lt; 2) return;

            // Simple logic: pick a random route
            Random rand = new Random(GameManager.Instance.WorldSeed + (int)GameManager.Instance.Time.CurrentGameTime);
            CaravanRoute route = _caravanRoutes.Values.ElementAt(rand.Next(_caravanRoutes.Count));

            // Check if origin/destination markets exist
            if (!_activeMarkets.ContainsKey(route.OriginSettlementID) || !_activeMarkets.ContainsKey(route.DestinationSettlementID))
            {
                GD.PrintErr($&quot;EconomyManager: Cannot spawn caravan for route '{route.ID}'. Markets not found.&quot;);
                return;
            }

            // Create a dummy caravan entity
            EntityID caravanEntityID = _entityManager.CreateEntity(EntityType.WorldObject, &quot;caravan_wagon_01&quot;, route.Waypoints.First(), 0f);
            if (!caravanEntityID.IsValid())
            {
                GD.PrintErr(&quot;EconomyManager: Failed to create entity for new caravan.&quot;);
                return;
            }

            // Populate cargo (simple for now)
            List&lt;InventoryItem&gt; cargo = new List&lt;InventoryItem&gt;();
            cargo.Add(new InventoryItem(&quot;iron_sword_t1&quot;, 5));
            cargo.Add(new InventoryItem(&quot;healing_potion_t1&quot;, 10));

            string factionID = _factionSystem.GetAllFactions().ElementAt(rand.Next(_factionSystem.GetAllFactions().Count)).ID; // Random faction
            Caravan newCaravan = new Caravan(caravanEntityID, $&quot;Caravan {GameManager.Instance.Time.CurrentDay}-{_activeCaravans.Count}&quot;, route.OriginSettlementID, route.DestinationSettlementID, factionID, route, 50f, cargo);
            _activeCaravans.Add(caravanEntityID, newCaravan);

            GD.Print($&quot;EconomyManager: Spawned new caravan '{newCaravan.Name}' ({caravanEntityID}) from {route.OriginSettlementID} to {route.DestinationSettlementID}.&quot;);
            _eventBus.Publish(new CaravanSpawnedEvent { CaravanID = caravanEntityID, Caravan = newCaravan });
        }

        /// &lt;summary&gt;
        /// Updates the position and progress of all active caravans.
        /// &lt;/summary&gt;
        private void UpdateActiveCaravans(double delta)
        {
            List&lt;EntityID&gt; completedCaravans = new List&lt;EntityID&gt;();
            foreach (var kvp in _activeCaravans)
            {
                EntityID caravanID = kvp.Key;
                Caravan caravan = kvp.Value;

                if (caravan.IsDestroyed || !caravan.IsActive) continue;

                // Calculate movement
                float distanceToTravel = caravan.Speed * (float)delta;
                caravan.CurrentProgress += distanceToTravel / caravan.CurrentRoute.Length;
                caravan.CurrentProgress = Mathf.Min(1.0f, caravan.CurrentProgress); // Clamp at 1.0

                // Update position in TransformSystem
                Vector2 newPosition = caravan.CurrentRoute.GetPositionAtProgress(caravan.CurrentProgress);
                _transformSystem.TrySetTransform(caravanID, new TransformComponent(newPosition));

                if (caravan.CurrentProgress &gt;= 1.0f)
                {
                    completedCaravans.Add(caravanID);
                }
            }

            // Process completed caravans
            foreach (EntityID id in completedCaravans)
            {
                Caravan completedCaravan = _activeCaravans[id];
                GD.Print($&quot;EconomyManager: Caravan '{completedCaravan.Name}' ({id}) reached destination {completedCaravan.DestinationSettlementID}.&quot;);

                // --- Economic Impact of Caravan Arrival --- (TDD 06.3.2)
                // Add cargo to destination market's supply
                SettlementMarket destinationMarket = GetMarket(completedCaravan.DestinationSettlementID);
                if (destinationMarket != null)
                {
                    foreach (var item in completedCaravan.Cargo)
                    {
                        MarketRecord record = destinationMarket.GetMarketRecord(item.ItemID);
                        record.CurrentSupply += item.Quantity; // Increase supply for arrived cargo
                        destinationMarket.AddOrUpdateItem(record);
                    }
                }
                // Reduce demand in destination market
                // Reduce prices in destination market
                // Improve reputation with faction

                _entityManager.DestroyEntity(id); // Despawn caravan entity
                _activeCaravans.Remove(id);
                _eventBus.Publish(new CaravanArrivedEvent { CaravanID = id, Caravan = completedCaravan });
            }
        }

        // ... (GetMarket, AddGlobalModifier, RemoveGlobalModifier methods) ...

        // --- Helper Events for Body Sync ---
        public struct MarketsUpdatedEvent { public List&lt;SettlementMarket&gt; Markets; }
        public struct CaravanSpawnedEvent { public EntityID CaravanID; public Caravan Caravan; }
        public struct CaravanArrivedEvent { public EntityID CaravanID; public Caravan Caravan; }
        public struct CaravanDestroyedEvent { public EntityID CaravanID; public EntityID KillerID; public string CaravanName; }
    }
}
</code></pre>
<h3 id="4-integrating-economymanager-into-gamemanager">4. Integrating <code>EconomyManager</code> into <code>GameManager</code></h3>
<ol>
<li>Open <code>res://_Brain/Core/GameManager.cs</code>.</li>
<li>Add <code>using Sigilborne.Systems.Economy;</code> at the top.</li>
<li>Modify <code>EconomyManager</code> initialization in <code>InitializeSystems()</code> to pass <code>EntityManager</code> and <code>TransformSystem</code>.</li>
<li>Call <code>EconomyManager.Tick(delta)</code> in <code>_PhysicsProcess</code>.</li>
</ol>
<pre><code class="language-csharp">// _Brain/Core/GameManager.cs
using Godot;
using System;
using Sigilborne.Core;
using Sigilborne.Entities;
using Sigilborne.Systems;
using Sigilborne.Systems.Biology;
using Sigilborne.Systems.Input;
using Sigilborne.Systems.Movement;
using Sigilborne.Systems.Physics;
using Sigilborne.Systems.Magic;
using Sigilborne.Systems.Weather;
using Sigilborne.Systems.StatusEffects;
using Sigilborne.Systems.Combat;
using Sigilborne.Systems.Inventory;
using Sigilborne.Systems.AI;
using Sigilborne.Systems.Factions;
using Sigilborne.Systems.Economy;
using Sigilborne.Utils;
using System.Linq;
using Sigilborne.Systems.Magic.Components;

public partial class GameManager : Node
{
    // ... (existing system properties) ...
    public EconomyManager Economy { get; private set; }

    public override void _Ready()
    {
        // ... (existing Instance check and InitializeSystems call) ...
        // ... (existing test entity/job code) ...
        // ... (existing glyph and magic system tests) ...
        // ... (existing damage tests) ...
        // ... (existing inventory/equipment tests) ...
        // ... (existing spatial grid tests) ...
        // ... (existing perception system tests) ...
        // ... (existing stealth system tests) ...
        // ... (existing AI system tests) ...
        // ... (existing ecology system tests) ...
        // ... (existing faction system tests) ...

        // --- Test Economy System ---
        GD.Print(&quot;\n--- Testing Economy System ---&quot;);
        // Add a test settlement market
        Economy.AddSettlementMarket(&quot;village_north&quot;, &quot;crimson_blades&quot;);
        Economy.AddSettlementMarket(&quot;town_south&quot;, &quot;sunken_temple&quot;);

        // Add a test caravan route
        CaravanRoute route1 = new CaravanRoute(&quot;route_north_south&quot;, &quot;village_north&quot;, &quot;town_south&quot;, new List&lt;Vector2&gt; { new Vector2(100, 100), new Vector2(500, 100), new Vector2(500, 500) });
        Economy.AddCaravanRoute(route1);

        // Initial check
        GD.Print($&quot;Initial iron_sword_t1 price in village_north: {Economy.GetMarket(&quot;village_north&quot;).GetMarketRecord(&quot;iron_sword_t1&quot;).CurrentPrice:F1}&quot;);
        GD.Print($&quot;Initial healing_potion_t1 price in town_south: {Economy.GetMarket(&quot;town_south&quot;).GetMarketRecord(&quot;healing_potion_t1&quot;).CurrentPrice:F1}&quot;);

        // Add a global modifier (e.g., &quot;war_active&quot;)
        Economy.AddGlobalModifier(&quot;war_active&quot;, 2.0f);
        Economy.AddGlobalModifier(&quot;famine_active&quot;, 3.0f);

        GD.Print(&quot;--- End Testing Economy System ---\n&quot;);
    }

    public override void _PhysicsProcess(double delta)
    {
        Input.ProcessInputBuffer(); 
        Time.Tick(delta);
        World.Tick(delta);
        Movement.Tick(delta);
        Magic.Tick(delta);
        Casting.Tick(delta);
        Weather.Tick(delta);
        Biology.Tick(delta);
        TitanAI.Tick(delta);
        StatusEffects.Tick(delta);
        Perception.Tick(delta);
        Stealth.Tick(delta);
        AI.Tick(delta);
        Ecology.Tick(delta);
        FactionAI.Tick(delta);
        Economy.Tick(delta);
        Events.FlushCommands();
    }

    private void InitializeSystems()
    {
        // ... (existing system initializations up to FactionSystem) ...

        FactionAI = new FactionAISystem(Events, Factions, Jobs, WorldSeed);
        GD.Print(&quot;  - FactionAISystem initialized.&quot;);

        // Initialize EconomyManager AFTER EquipmentSystem, FactionSystem, EntityManager, TransformSystem
        Economy = new EconomyManager(Events, Equipment, Factions, Entities, Transforms); // Pass dependencies
        GD.Print(&quot;  - EconomyManager initialized.&quot;);

        // Initialize PlayerStatSystem, passing BiologicalSystem
        PlayerStats = new PlayerStatSystem(Events, Entities, BiologicalSystem);
        GD.Print(&quot;  - PlayerStatSystem initialized.&quot;);

        World = new WorldSimulation(Ecology);
        GD.Print(&quot;  - WorldSimulation initialized.&quot;);
    }
}
</code></pre>
<h4 id="41-update-eventbuscs-for-caravan-events">4.1. Update <code>EventBus.cs</code> for Caravan Events</h4>
<p>Open <code>res://_Brain/Core/EventBus.cs</code> and add <code>OnCaravanSpawned</code>, <code>OnCaravanArrived</code>, <code>OnCaravanDestroyed</code> delegates.</p>
<pre><code class="language-csharp">// _Brain/Core/EventBus.cs
using System;
using System.Collections.Concurrent;
using Godot;
using Sigilborne.Entities;
using Sigilborne.Systems.Biology;
using Sigilborne.Systems.Magic;
using Sigilborne.Systems.StatusEffects;
using Sigilborne.Systems.Combat;
using Sigilborne.Systems.Inventory;
using Sigilborne.Systems.AI;
using Sigilborne.Systems.Factions;
using Sigilborne.Systems.Economy;
using System.Collections.Generic;

namespace Sigilborne.Core
{
    public class EventBus
    {
        // ... (existing events) ...

        // Economy System Events (TDD 06.3.1)
        public event Action&lt;List&lt;SettlementMarket&gt;&gt; OnMarketsUpdated;

        // Caravan Events (TDD 06.3.2)
        public event Action&lt;EntityID, Caravan&gt; OnCaravanSpawned;
        public event Action&lt;EntityID, Caravan&gt; OnCaravanArrived;
        public event Action&lt;EntityID, EntityID, string&gt; OnCaravanDestroyed; // CaravanID, KillerID, CaravanName

        // ... (existing _commandBuffer) ...

        public void Publish&lt;TEvent&gt;(TEvent eventData)
        {
            // ... (existing publish conditions) ...
            else if (eventData is EconomyManager.MarketsUpdatedEvent marketsUpdatedEvent)
            {
                OnMarketsUpdated?.Invoke(marketsUpdatedEvent.Markets);
            }
            else if (eventData is EconomyManager.CaravanSpawnedEvent caravanSpawnedEvent) // New condition
            {
                OnCaravanSpawned?.Invoke(caravanSpawnedEvent.CaravanID, caravanSpawnedEvent.Caravan);
            }
            else if (eventData is EconomyManager.CaravanArrivedEvent caravanArrivedEvent) // New condition
            {
                OnCaravanArrived?.Invoke(caravanArrivedEvent.CaravanID, caravanArrivedEvent.Caravan);
            }
            else if (eventData is EconomyManager.CaravanDestroyedEvent caravanDestroyedEvent) // New condition
            {
                OnCaravanDestroyed?.Invoke(caravanDestroyedEvent.CaravanID, caravanDestroyedEvent.KillerID, caravanDestroyedEvent.CaravanName);
            }
            else
            {
                GD.PrintErr($&quot;EventBus: Attempted to publish unknown event type: {typeof(TEvent).Name}. Ensure it's handled in Publish&lt;TEvent&gt;.&quot;);
            }
        }
        // ... (AddCommand and FlushCommands methods) ...
    }
}
</code></pre>
<h3 id="5-testing-trade-routes-and-caravans">5. Testing Trade Routes and Caravans</h3>
<ol>
<li>Save all C# and GDScript files.</li>
<li>Run <code>Main.tscn</code>.</li>
<li>Load <code>Gameplay.tscn</code>.</li>
<li>Observe the console output.<ul>
<li><code>EconomyManager: Added market for settlement 'village_north'.</code></li>
<li><code>EconomyManager: Added market for settlement 'town_south'.</code></li>
<li><code>EconomyManager: Added trade route 'route_north_south': village_north to town_south.</code></li>
<li>Every 2 real minutes (120 game minutes), <code>EconomyManager: Spawned new caravan 'Caravan X-Y' ...</code> messages will appear.</li>
<li>You should see these caravan entities moving on screen (they are <code>EntityType.WorldObject</code> and get <code>TransformComponent</code>s).</li>
<li>After a caravan reaches its destination (progress 1.0), you'll see <code>EconomyManager: Caravan 'X' reached destination...</code> and <code>EntityManager: Destroyed entity...</code> messages.</li>
<li>If you continuously spawn and destroy caravans (e.g. by using the debug console to speed up time, or by running the game for a while), you'll also see their economic impact on market prices in the <code>UpdateAllMarkets</code> calls.</li>
</ul>
</li>
</ol>
<p>This demonstrates that:
*   <code>CaravanRoute</code>s and <code>Caravan</code> entities are correctly defined.
*   <code>EconomyManager</code> spawns caravans, updates their positions, and destroys them upon arrival.
*   Caravan destruction (simulated by <code>OnEntityDefeated</code> if you kill a caravan entity) correctly impacts the destination market's supply.</p>
<h3 id="summary">Summary</h3>
<p>You have successfully implemented <strong>Trade Routes</strong> and <strong>Caravans</strong> in the C# Brain, designing <code>Caravan</code> and <code>CaravanRoute</code> classes to represent physical trade entities and their paths. By enhancing <code>EconomyManager</code> to manage route definitions, spawn caravans, update their progress, and simulate their economic impact upon arrival or destruction, you've established a robust mechanism for dynamic goods flow. This crucial system strictly adheres to TDD 06.3.2's specifications, allowing trade to visibly influence supply chains and local market prices in Sigilborne.</p>
<h3 id="next-steps">Next Steps</h3>
<p>The next chapter will focus on <strong>Crime &amp; Justice - The Heat System (C#)</strong>, where we will implement a system to track "Heat" (criminal notoriety) per faction, based on player crimes, and design how witnesses report these crimes, leading to escalating consequences.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.sections", "navigation.expand", "content.code.copy"], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>